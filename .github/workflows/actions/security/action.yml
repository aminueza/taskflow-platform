name: "Container Security Scan"
description: "Scan container images using CodeQL and Trivy for security vulnerabilities"

inputs:
  dockerfile-dir:
    description: "Path to Dockerfile"
    required: false
    default: "Dockerfile"
  severity:
    description: "Severity levels to check (CRITICAL,HIGH,MEDIUM,LOW)"
    required: false
    default: "CRITICAL,HIGH"
  vuln-type:
    description: "Types of vulnerabilities to check (os,library,config)"
    required: false
    default: "os,library"
  ignore-unfixed:
    description: "Whether to ignore unfixed vulnerabilities"
    required: false
    default: "true"
  format:
    description: "Output format (table,json,sarif)"
    required: false
    default: "sarif"
  exit-code:
    description: "Exit code when vulnerabilities are found"
    required: false
    default: "1"
  limit-severities-for-sarif:
    description: "By default SARIF format enforces output of all vulnerabilities regardless of configured severities. To override this behavior set this parameter to true"
    required: false
    default: "false"
  category:
    description: "Unique category for SARIF upload (e.g., security-api)"
    required: false
    default: "container-security"

runs:
  using: "composite"
  steps:
    - name: 'üîç Run Trivy Dockerfile scanner'
      id: trivy
      uses: aquasecurity/trivy-action@0.33.1
      continue-on-error: true
      with:
        scan-type: 'fs'
        scan-ref: ${{ inputs.dockerfile-dir }}
        format: ${{ inputs.format }}
        exit-code: ${{ inputs.exit-code }}
        ignore-unfixed: ${{ inputs.ignore-unfixed }}
        vuln-type: ${{ inputs.vuln-type }}
        severity: ${{ inputs.severity }}
        limit-severities-for-sarif: ${{ inputs.limit-severities-for-sarif }}
        cache: 'true'
        output: ./trivy-${{ inputs.category }}.sarif
        scanners: 'vuln,secret'

    - name: 'üìä Upload Trivy results to GitHub Security'
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: ./trivy-${{ inputs.category }}.sarif
        category: ${{ inputs.category }}

    - name: 'üìù Process and Display Results'
      shell: bash
      env:
        SARIF_FILE: ./trivy-${{ inputs.category }}.sarif
        CATEGORY: ${{ inputs.category }}
      run: |
        if [ -f "$SARIF_FILE" ]; then
          # Count vulnerabilities
          VULN_COUNT=$(jq '.runs[0].results | length' "$SARIF_FILE")
          
          # Add results to GitHub summary
          {
            echo "### üîç Security Scan: ${CATEGORY}"
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "‚ö†Ô∏è Found $VULN_COUNT vulnerabilities:"
              echo ""
              echo "| Severity | Message | Location |"
              echo "|----------|---------|----------|"
              jq -r '.runs[0].results[] | "| \(.level) | \(.message.text) | \(.locations[0].physicalLocation.artifactLocation.uri) |"' "$SARIF_FILE"
              echo ""
              echo "<details><summary>Raw SARIF Output</summary>"
              echo ""
              echo '```json'
              jq '.' "$SARIF_FILE"
              echo '```'
              echo "</details>"
            else
              echo "‚úÖ No vulnerabilities found!"
            fi
          } >> $GITHUB_STEP_SUMMARY
        fi

    - name: '‚ö†Ô∏è Fail on Critical Issues'
      if: ${{ steps.trivy.outcome == 'failure' }}
      shell: bash
      run: |
        echo "::error::Critical security vulnerabilities found in Dockerfile"
        exit 1
