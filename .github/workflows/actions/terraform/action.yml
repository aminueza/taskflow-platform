name: "Terraform Deploy"
description: "Reusable Terraform workflow with Azure OIDC federated identity"

inputs:
  working-directory:
    description: "Path to Terraform configuration"
    required: true
  terraform-version:
    description: "Terraform version to use"
    required: false
    default: "1.14.3"
  azure-client-id:
    description: "Azure Service Principal Client ID"
    required: true
  azure-subscription-id:
    description: "Azure Subscription ID"
    required: true
  azure-tenant-id:
    description: "Azure Tenant ID"
    required: true
  plan-only:
    description: "Run plan only without apply"
    required: false
    default: "false"
  tfvars-file:
    description: "Path to tfvars file (relative to working-directory)"
    required: false
    default: ""
  backend-config:
    description: "Backend configuration (key=value format, one per line)"
    required: false
    default: ""
  additional-args:
    description: "Additional Terraform arguments"
    required: false
    default: ""
  auto-approve:
    description: "Auto-approve apply without confirmation"
    required: false
    default: "true"

outputs:
  plan-exitcode:
    description: "Exit code from terraform plan (0=no changes, 2=changes)"
    value: ${{ steps.plan.outputs.exitcode }}
  apply-exitcode:
    description: "Exit code from terraform apply"
    value: ${{ steps.apply.outputs.exitcode }}
  outputs-json:
    description: "Terraform outputs as JSON"
    value: ${{ steps.outputs.outputs.json }}

runs:
  using: "composite"
  steps:
    - name: "ğŸ“¦ Install Dependencies"
      shell: bash
      run: |
        # Install unzip if not present (needed for self-hosted runners)
        if ! command -v unzip &> /dev/null; then
          echo "Installing unzip..."
          sudo apt-get update -qq && sudo apt-get install -y -qq unzip
        fi

    - name: "ğŸ”§ Setup Terraform"
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform-version }}
        terraform_wrapper: false

    - name: "ğŸ” Azure Login (OIDC)"
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.azure-client-id }}
        tenant-id: ${{ inputs.azure-tenant-id }}
        subscription-id: ${{ inputs.azure-subscription-id }}

    - name: "ğŸ“‹ Terraform Format Check"
      id: fmt
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: terraform fmt -check -recursive
      continue-on-error: true

    - name: "ğŸš€ Terraform Init"
      id: init
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        ARM_CLIENT_ID: ${{ inputs.azure-client-id }}
        ARM_SUBSCRIPTION_ID: ${{ inputs.azure-subscription-id }}
        ARM_TENANT_ID: ${{ inputs.azure-tenant-id }}
        ARM_USE_OIDC: "true"
        BACKEND_CONFIG: ${{ inputs.backend-config }}
      run: |
        INIT_ARGS=""
        if [ -n "$BACKEND_CONFIG" ]; then
          while IFS= read -r line; do
            [ -n "$line" ] && INIT_ARGS="$INIT_ARGS -backend-config=$line"
          done <<< "$BACKEND_CONFIG"
        fi
        terraform init $INIT_ARGS

    - name: "âœ… Terraform Validate"
      id: validate
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: terraform validate -no-color

    - name: "ğŸ“ Terraform Plan"
      id: plan
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        ARM_CLIENT_ID: ${{ inputs.azure-client-id }}
        ARM_SUBSCRIPTION_ID: ${{ inputs.azure-subscription-id }}
        ARM_TENANT_ID: ${{ inputs.azure-tenant-id }}
        ARM_USE_OIDC: "true"
        TFVARS_FILE: ${{ inputs.tfvars-file }}
        ADDITIONAL_ARGS: ${{ inputs.additional-args }}
      run: |
        PLAN_ARGS="-out=tfplan -detailed-exitcode"
        [ -n "$TFVARS_FILE" ] && PLAN_ARGS="$PLAN_ARGS -var-file=$TFVARS_FILE"
        [ -n "$ADDITIONAL_ARGS" ] && PLAN_ARGS="$PLAN_ARGS $ADDITIONAL_ARGS"
        
        set +e
        terraform plan $PLAN_ARGS
        EXITCODE=$?
        set -e
        
        echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
        
        # Exit code 2 means changes detected (not an error)
        if [ $EXITCODE -eq 1 ]; then
          exit 1
        fi

    - name: "ğŸš€ Terraform Apply"
      id: apply
      if: ${{ inputs.plan-only == 'false' }}
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        ARM_CLIENT_ID: ${{ inputs.azure-client-id }}
        ARM_SUBSCRIPTION_ID: ${{ inputs.azure-subscription-id }}
        ARM_TENANT_ID: ${{ inputs.azure-tenant-id }}
        ARM_USE_OIDC: "true"
        AUTO_APPROVE: ${{ inputs.auto-approve }}
      run: |
        APPLY_ARGS=""
        [ "$AUTO_APPROVE" == "true" ] && APPLY_ARGS="-auto-approve"
        
        terraform apply $APPLY_ARGS tfplan
        echo "exitcode=$?" >> $GITHUB_OUTPUT

    - name: "ğŸ“Š Terraform Outputs"
      id: outputs
      if: ${{ inputs.plan-only == 'false' }}
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        OUTPUTS=$(terraform output -json 2>/dev/null || echo '{}')
        echo "json=$OUTPUTS" >> $GITHUB_OUTPUT

    - name: "ğŸ“‹ Generate Summary"
      shell: bash
      env:
        FMT_OUTCOME: ${{ steps.fmt.outcome }}
        INIT_OUTCOME: ${{ steps.init.outcome }}
        VALIDATE_OUTCOME: ${{ steps.validate.outcome }}
        PLAN_EXITCODE: ${{ steps.plan.outputs.exitcode }}
        APPLY_OUTCOME: ${{ steps.apply.outcome }}
        WORKING_DIR: ${{ inputs.working-directory }}
        PLAN_ONLY: ${{ inputs.plan-only }}
      run: |
        {
          echo "### ğŸ—ï¸ Terraform Deployment Summary"
          echo ""
          echo "| Step | Status |"
          echo "|------|--------|"
          echo "| ğŸ“ Working Directory | \`$WORKING_DIR\` |"
          echo "| ğŸ“‹ Format Check | $([[ "$FMT_OUTCOME" == "success" ]] && echo "âœ… Passed" || echo "âš ï¸ Issues found") |"
          echo "| ğŸš€ Init | $([[ "$INIT_OUTCOME" == "success" ]] && echo "âœ… Success" || echo "âŒ Failed") |"
          echo "| âœ… Validate | $([[ "$VALIDATE_OUTCOME" == "success" ]] && echo "âœ… Valid" || echo "âŒ Invalid") |"
          
          case "$PLAN_EXITCODE" in
            0) echo "| ğŸ“ Plan | âœ… No changes |" ;;
            2) echo "| ğŸ“ Plan | ğŸ”„ Changes detected |" ;;
            *) echo "| ğŸ“ Plan | âŒ Failed |" ;;
          esac
          
          if [ "$PLAN_ONLY" == "false" ]; then
            echo "| ğŸš€ Apply | $([[ "$APPLY_OUTCOME" == "success" ]] && echo "âœ… Applied" || echo "â­ï¸ Skipped") |"
          else
            echo "| ğŸš€ Apply | â­ï¸ Plan only mode |"
          fi
        } >> $GITHUB_STEP_SUMMARY
